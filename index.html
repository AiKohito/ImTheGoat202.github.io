<script>
    const maxAttempts = 3;
    const lockoutDuration = 30 * 60 * 1000; // 30 minutes in milliseconds

    async function authenticate() {
        const passcode = document.getElementById("passcode").value;

        // Save the entered passcode in localStorage
        localStorage.setItem("enteredPasscode", passcode);

        // Hash the entered passcode with MD5
        const hashedPasscode = CryptoJS.MD5(passcode).toString();

        let attempts = parseInt(localStorage.getItem("attempts") || "0");
        let lockoutTime = parseInt(localStorage.getItem("lockoutTime") || "0");

        function updateCountdown() {
            const now = Date.now();
            const timeLeft = lockoutTime - now;
            if (timeLeft > 0) {
                const minutes = Math.floor(timeLeft / 60000);
                const seconds = Math.floor((timeLeft % 60000) / 1000);
                document.getElementById("countdown-timer").textContent = `${minutes} minute(s) and ${seconds} second(s)`;
                setTimeout(updateCountdown, 1000);
            } else {
                document.getElementById("lockout-message").style.display = "none";
                localStorage.removeItem("lockoutTime");
                localStorage.removeItem("attempts");
            }
        }

        if (Date.now() < lockoutTime) {
            document.getElementById("lockout-message").style.display = "block";
            updateCountdown();
            return;
        } else {
            document.getElementById("lockout-message").style.display = "none";
            localStorage.removeItem("lockoutTime");
        }

        // Fetch the hashed passcode from the file
        const response = await fetch("https://raw.githubusercontent.com/MCRed2024/urlfetcher/main/fetcher.txt");
        const fullResponse = await response.text();

        if (hashedPasscode === fullResponse.trim()) {
            document.getElementById("content").style.display = "block";
            document.getElementById("myTopnav").style.display = "block";
            document.getElementById("passcode-form").style.display = "none";
            localStorage.removeItem("attempts");
        } else {
            attempts++;
            localStorage.setItem("attempts", attempts);
            if (attempts >= maxAttempts) {
                lockoutTime = Date.now() + lockoutDuration;
                localStorage.setItem("lockoutTime", lockoutTime);
                document.getElementById("lockout-message").style.display = "block";
                updateCountdown();
            } else {
                alert("Incorrect passcode. Please try again.");
            }
        }
    }

    // Check if the user has already entered the correct passcode on page load
    async function checkPasscode() {
        const storedPasscode = localStorage.getItem("enteredPasscode");
        if (storedPasscode) {
            const hashedStoredPasscode = CryptoJS.MD5(storedPasscode).toString();

            // Fetch the hashed passcode from the file
            const response = await fetch("https://raw.githubusercontent.com/MCRed2024/urlfetcher/main/fetcher.txt");
            const fullResponse = await response.text();

            // Check if the stored hashed passcode matches the fetched one
            if (hashedStoredPasscode === fullResponse.trim()) {
                document.getElementById("content").style.display = "block";
                document.getElementById("myTopnav").style.display = "block";
                document.getElementById("passcode-form").style.display = "none";
            }
        }
    }

    // Call the check function on page load
    window.onload = checkPasscode;

    document.getElementById("passcode").addEventListener("keydown", function(event) {
        if (event.keyCode == 13) { // Enter key
            authenticate();
        }
    });

    document.getElementById("submit-button").addEventListener("click", authenticate);

    // Additional logic for logout
    document.getElementById("logout").addEventListener("click", function() {
        // Remove the enteredPasscode variable from localStorage
        localStorage.removeItem("enteredPasscode");

        // Reload the page
        location.reload();
    });
</script>
